<div id="app">
  <button id="loginBtn">Login via OneLogin</button>

  <div id="welcome" style="display:none;">
    <h1>HEY, <span id="name"></span>!</h1>
    <input type="text" id="phone" placeholder="User Phone Number"/>
    <button id="lookupBtn">Lookup</button>
    <div id="result"></div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<script>
async function callCloudKit(action, phone, reason) {
  const resp = await fetch('/api/cloudkit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, phoneNumber: phone, reason })
  });
  try { return await resp.json(); }
  catch(e) { const text = await resp.text(); return { error:'Failed JSON parse', raw:text }; }
}

async function lookupUser() {
  const phone = document.getElementById('phone').value.trim();
  const data = await callCloudKit('lookup', phone);
  const resultDiv = document.getElementById('result');

  if (data.records && data.records.length > 0) {
    resultDiv.innerHTML = `User banned. <button onclick="unban('${phone}')">Unban</button>`;
  } else {
    resultDiv.innerHTML = `User NOT banned. <button onclick="ban('${phone}')">Ban</button>`;
  }
}

async function ban(phone) {
  const reason = prompt("Enter ban reason:");
  if (!reason) return;
  await callCloudKit('ban', phone, reason);
  alert("User banned!");
}

async function unban(phone) {
  await callCloudKit('unban', phone);
  alert("User unbanned!");
}

function showWelcome(name) {
  document.getElementById('loginBtn').style.display = 'none';
  document.getElementById('welcome').style.display = 'block';
  document.getElementById('name').innerText = name;
}

function logout() {
  localStorage.clear();
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('loginBtn').style.display = 'block';
}

// Placeholder OneLogin login flow
document.getElementById('loginBtn').onclick = () => {
  const fakeName = "Employee"; // Replace with real OneLogin info
  localStorage.setItem("user_name", fakeName);
  showWelcome(fakeName);
};

document.getElementById('logoutBtn').onclick = logout;

if (localStorage.getItem("user_name")) {
  showWelcome(localStorage.getItem("user_name"));
}

document.getElementById('lookupBtn').onclick = lookupUser;
</script>
