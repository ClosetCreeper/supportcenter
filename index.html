<!DOCTYPE html>
<html>
<head>
  <title>Ban Resolution Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; padding:30px; }
    #app { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    input { padding:10px; width:calc(100% - 24px); margin:10px 0; border-radius:5px; border:1px solid #ccc; }
    button { padding:10px 15px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; margin:5px 0; }
    button:hover { background:#0056b3; }
    #result { margin-top:15px; }
  </style>
</head>
<body>
<div id="app">
  <button id="loginBtn">Login via OneLogin</button>

  <div id="welcome" style="display:none;">
    <h1>HEY, <span id="name"></span>!</h1>
    <input type="text" id="phone" placeholder="User Phone Number"/>
    <button id="lookupBtn">Lookup</button>
    <div id="result"></div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<script>
async function callCloudKit(action, phone, reason) {
  const resp = await fetch('/api/cloudkit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, phoneNumber: phone, reason })
  });
  const text = await resp.text(); // read body once
  try { return JSON.parse(text); } 
  catch(e) { return { error:'Failed JSON parse', raw:text }; }
}

async function lookupUser() {
  const phone = document.getElementById('phone').value.trim();
  if (!phone) return alert("Enter a phone number");
  const data = await callCloudKit('lookup', phone);
  const resultDiv = document.getElementById('result');

  if (data.records && data.records.length > 0) {
    resultDiv.innerHTML = `User banned. <button onclick="unban('${phone}')">Unban</button>`;
  } else {
    resultDiv.innerHTML = `User NOT banned. <button onclick="ban('${phone}')">Ban</button>`;
  }
}

async function ban(phone) {
  const reason = prompt("Enter ban reason:");
  if (!reason) return;
  await callCloudKit('ban', phone, reason);
  alert("User banned!");
  lookupUser();
}

async function unban(phone) {
  await callCloudKit('unban', phone);
  alert("User unbanned!");
  lookupUser();
}

function showWelcome(name) {
  document.getElementById('loginBtn').style.display = 'none';
  document.getElementById('welcome').style.display = 'block';
  document.getElementById('name').innerText = name;
}

function logout() {
  localStorage.clear();
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('loginBtn').style.display = 'block';
}

// Placeholder OneLogin login flow
document.getElementById('loginBtn').onclick = () => {
  const fakeName = "Employee"; // Replace with real OneLogin OAuth
  localStorage.setItem("user_name", fakeName);
  showWelcome(fakeName);
};

document.getElementById('logoutBtn').onclick = logout;

if (localStorage.getItem("user_name")) {
  showWelcome(localStorage.getItem("user_name"));
}

document.getElementById('lookupBtn').onclick = lookupUser;
</script>
</body>
</html>
